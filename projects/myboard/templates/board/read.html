{# common/base.html을 상속받겠음 #}
{% extends 'common/base.html' %}
{% block title %}[게시판]{% endblock title%}

{% block body %}
<script>
  function showUpdateForm(rid){
    let replyText = document.getElementById('replyText').value;
    // location.href = '/board/'+ '{{board.id}}' + '/update_reply?rid=' + rid;
    $.ajax({
      url : '/board/'+ '{{board.id}}' + '/update_reply?rid=' + rid,
      success : function(reply){
        console.log(rid)
        document.getElementById('rid').value = rid
        document.getElementById('replyText').value = reply.replyText
        $("#btnUpdate").show();
        $("#btnReply").hide();
      }
    })
  }
  function updateReply(){
    let rid =  document.getElementById('rid').value;
    let replyText = document.getElementById('replyText').value;
    $.ajax({
      url : '/board/{{board.id}}/update_reply/',
      type : 'post',
      headers : {'X-CSRFTOKEN': '{{csrf_token}}'},
      data : {'rid' : rid, 'replyText' : replyText},
      success: function(response){
        document.getElementById('replyText').value = "";
        $("#btnUpdate").hide();
				$("#btnReply").show();
        loadReplyList();
      }
    })
  }

  function writeReply(){
    let replyText = document.getElementById('replyText').value;

    $.ajax({
      url: '/board/{{board.id}}/write_reply/',
      type : 'post',
      headers : {'X-CSRFTOKEN': '{{csrf_token}}'},
      data : {'replyText' : replyText},
      success : function(response){
        document.getElementById('replyText').value = "";
        loadReplyList();
      }
    });
  }
  
  function deleteReply(rid){
    // location.href = "delete_reply/" + rid;
    $.ajax({
      url: '/board/{{board.id}}/delete_reply/'+rid+'/',
      type : 'post',
      headers : {'X-CSRFTOKEN': '{{csrf_token}}'},
      success : function(response){
        document.getElementById('replyText').value = "";
        $("#btnUpdate").hide();
				$("#btnReply").show();
        loadReplyList();
      }
    });
  }

  $(document).ready(function(){
    $("#btnUpdate").hide();
    loadReplyList();
  });

  function loadReplyList(){
    let bNum = '{{board.id}}';
    console.log(bNum);
    $.ajax({
      url: '/board/load_reply/',
      type: 'post',
      headers : {'X-CSRFTOKEN': '{{csrf_token}}'},
      data: {'id':bNum},
      success: function(response){
        console.log(JSON.parse(response.response))
        
        let replyList = JSON.parse(response.response)
        let str = '';
        $.each(replyList, function(i, item){
          let replyContent = item.fields.reply_content;
          // // 바로바로 화면에 붙이려면 append
          // $('#replyList').append(replyContent);
          str += replyContent;
          str += " <a href='#' onclick='showUpdateForm(" + item.pk +");'>수정</a>/"
          str += " <a href='#' onclick='deleteReply(" + item.pk +");'>삭제</a>"
          str += "<br>";
        })
        // HTML을 만들어서 한번에 넣으려면 html
        $('#replyList').html(str);
      }
    });
  }
</script>
<h1>글 보기</h1>
<table>
  <tr>
    <th>{{ board.id }}</th>
    <th>{{ board.title }}</th>
    <td>{{ board.view_count }}</td>
  </tr>
  <tr>
    <td colspan="2">{{ board.input_date|date:'y.m.d H:i' }}</td>
    <td>{{ board.writer }}</td>
  </tr>
  <tr>
    <td colspan="4">{{ board.content }}</td>
  </tr>
</table>
<!-- 수정/삭제 -->
<!-- username끼리 비교하려면 -->
{% if board.author.username == user.username %}
<a href="{% url 'board:update' board.id %}">수정</a> /
<a href="{% url 'board:delete' board.id %}" onclick="javascript: return confirm('정말 삭제 하시겠어요?')">삭제</a>
{% endif %}
<div id = 'replyArea'>
  <!-- 댓글 목록 표시할 곳 -->
  <div id="replyList">
    <!-- board 객체 뿐만 아니라 board와 FK로 엮인 객체는 -->
    <!-- board.모델이름_set으로 가져올 수 있다 -->
  </div>
  <!-- 댓글 입력 폼 -->
  <div id="replyForm">
    <input type="hidden" id="rid">
    <textarea id="replyText"></textarea>
    <input type="button" id="btnReply" value="댓글쓰기" onclick="writeReply()">
    <input type="button" id="btnUpdate" value="댓글수정" onclick="updateReply()">
  </div>
</div>
<form action="{% url 'board:index' %}">
  <input type="submit" value="목록으로" />
</form>
{% endblock body %}